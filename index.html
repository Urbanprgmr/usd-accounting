<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaction History App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .action-button {
      margin: 2px;
    }
    .form-container {
      margin-bottom: 20px;
    }
    .form-container input, .form-container select, .form-container button {
      margin: 5px;
      padding: 8px;
      width: 200px;
    }
    #resetButton {
      background-color: #ff4d4d;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
    }
    #resetButton:hover {
      background-color: #cc0000;
    }
  </style>
</head>
<body>
  <h1>Transaction History App</h1>

  <!-- Balance Capital Display -->
  <div>
    <h2>Balance Capital: <span id="balanceCapital">0.00</span></h2>
  </div>

  <!-- Reset Button -->
  <button id="resetButton">Reset All Data</button>

  <!-- Buy Form -->
  <div class="form-container">
    <h3>Buy Transaction</h3>
    <form id="buyForm">
      <select id="buyCurrency">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="USDT">USDT</option>
      </select>
      <input type="number" id="buyAmount" placeholder="Amount" step="0.01" required>
      <input type="number" id="buyRate" placeholder="Rate (MVR)" step="0.01" required>
      <input type="text" id="buyRemarks" placeholder="Remarks">
      <button type="submit">Buy</button>
    </form>
  </div>

  <!-- Sell Form -->
  <div class="form-container">
    <h3>Sell Transaction</h3>
    <form id="sellForm">
      <select id="sellCurrency">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="USDT">USDT</option>
      </select>
      <input type="number" id="sellAmount" placeholder="Amount" step="0.01" required>
      <input type="number" id="sellRate" placeholder="Rate (MVR)" step="0.01" required>
      <input type="text" id="sellRemarks" placeholder="Remarks">
      <button type="submit">Sell</button>
    </form>
  </div>

  <!-- Take Profit Form -->
  <div class="form-container">
    <h3>Take Profit</h3>
    <form id="takeProfitForm">
      <input type="number" id="takeProfitAmount" placeholder="Amount" step="0.01" required>
      <button type="submit">Take Profit</button>
    </form>
  </div>

  <!-- Transaction History Table -->
  <h3>Transaction History</h3>
  <table id="transactionHistory">
    <thead>
      <tr>
        <th>Type</th>
        <th>Currency</th>
        <th>Amount</th>
        <th>Rate (MVR)</th>
        <th>Remarks</th>
        <th>Timestamp</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Transactions will be populated here -->
    </tbody>
  </table>

  <!-- JavaScript Code -->
  <script>
    // Initialize data
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let totalPurchased = {
      USD: parseFloat(localStorage.getItem('totalPurchasedUSD')) || 0,
      EUR: parseFloat(localStorage.getItem('totalPurchasedEUR')) || 0,
      USDT: parseFloat(localStorage.getItem('totalPurchasedUSDT')) || 0,
    };
    let totalSold = {
      USD: parseFloat(localStorage.getItem('totalSoldUSD')) || 0,
      EUR: parseFloat(localStorage.getItem('totalSoldEUR')) || 0,
      USDT: parseFloat(localStorage.getItem('totalSoldUSDT')) || 0,
    };
    let totalBuyCost = parseFloat(localStorage.getItem('totalBuyCost')) || 0;
    let totalSellRevenue = parseFloat(localStorage.getItem('totalSellRevenue')) || 0;
    let totalPaymentIn = parseFloat(localStorage.getItem('totalPaymentIn')) || 0;
    let totalPaymentOut = parseFloat(localStorage.getItem('totalPaymentOut')) || 0;
    let initialCapital = parseFloat(localStorage.getItem('initialCapital')) || 0;
    let amountDeducted = parseFloat(localStorage.getItem('amountDeducted')) || 0;
    let balanceCapital = parseFloat(localStorage.getItem('balanceCapital')) || 0;
    let totalTakenProfit = parseFloat(localStorage.getItem('totalTakenProfit')) || 0;

    // Load saved data on page load
    document.addEventListener('DOMContentLoaded', () => {
      updateUI();
    });

    // Save Data to LocalStorage
    function saveToLocalStorage() {
      localStorage.setItem('transactions', JSON.stringify(transactions));
      localStorage.setItem('totalPurchasedUSD', totalPurchased.USD);
      localStorage.setItem('totalPurchasedEUR', totalPurchased.EUR);
      localStorage.setItem('totalPurchasedUSDT', totalPurchased.USDT);
      localStorage.setItem('totalSoldUSD', totalSold.USD);
      localStorage.setItem('totalSoldEUR', totalSold.EUR);
      localStorage.setItem('totalSoldUSDT', totalSold.USDT);
      localStorage.setItem('totalBuyCost', totalBuyCost);
      localStorage.setItem('totalSellRevenue', totalSellRevenue);
      localStorage.setItem('totalPaymentIn', totalPaymentIn);
      localStorage.setItem('totalPaymentOut', totalPaymentOut);
      localStorage.setItem('initialCapital', initialCapital);
      localStorage.setItem('amountDeducted', amountDeducted);
      localStorage.setItem('balanceCapital', balanceCapital);
      localStorage.setItem('totalTakenProfit', totalTakenProfit);
    }

    // Reset LocalStorage and App Data
    function resetApp() {
      if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
        // Clear localStorage
        localStorage.clear();

        // Reset all variables to initial state
        transactions = [];
        totalPurchased = { USD: 0, EUR: 0, USDT: 0 };
        totalSold = { USD: 0, EUR: 0, USDT: 0 };
        totalBuyCost = 0;
        totalSellRevenue = 0;
        totalPaymentIn = 0;
        totalPaymentOut = 0;
        initialCapital = 0;
        amountDeducted = 0;
        balanceCapital = 0;
        totalTakenProfit = 0;

        // Update UI
        updateUI();
      }
    }

    // Update UI
    function updateUI() {
      // Update Balance Capital
      document.getElementById('balanceCapital').textContent = balanceCapital.toFixed(2);

      // Update Transaction History
      const tbody = document.querySelector('#transactionHistory tbody');
      tbody.innerHTML = transactions.map((transaction, index) => `
        <tr>
          <td>${transaction.type}</td>
          <td>${transaction.currency}</td>
          <td>${transaction.amount.toFixed(2)}</td>
          <td>${transaction.rate.toFixed(2)}</td>
          <td>${transaction.remarks}</td>
          <td>${transaction.timestamp}</td>
          <td>
            <button class="action-button edit-button" onclick="editTransaction(${index})">Edit</button>
            <button class="action-button delete-button" onclick="deleteTransaction(${index})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // Edit Transaction
    function editTransaction(index) {
      const transaction = transactions[index];
      const newAmount = parseFloat(prompt(`Enter new amount for ${transaction.type} (${transaction.currency}):`, transaction.amount));
      const newRate = parseFloat(prompt(`Enter new rate for ${transaction.type} (${transaction.currency}):`, transaction.rate));
      const newRemarks = prompt(`Enter new remarks for ${transaction.type}:`, transaction.remarks);

      if (newAmount === null || newRate === null || isNaN(newAmount) || isNaN(newRate)) {
        alert('Invalid input. Transaction not updated.');
        return;
      }

      // Revert the old transaction's impact on totals
      if (transaction.type === 'Buy') {
        totalPurchased[transaction.currency] -= transaction.amount;
        totalBuyCost -= transaction.amount * transaction.rate;
        balanceCapital += transaction.amount * transaction.rate; // Add back to capital
      } else if (transaction.type === 'Sell') {
        totalSold[transaction.currency] -= transaction.amount;
        totalSellRevenue -= transaction.amount * transaction.rate;
        balanceCapital -= transaction.amount * transaction.rate; // Deduct from capital
      } else if (transaction.type === 'Take Profit') {
        totalTakenProfit -= transaction.amount;
        balanceCapital += transaction.amount; // Add back to capital
      }

      // Update the transaction with new values
      transaction.amount = newAmount;
      transaction.rate = newRate;
      transaction.remarks = newRemarks;

      // Apply the new transaction's impact on totals
      if (transaction.type === 'Buy') {
        totalPurchased[transaction.currency] += newAmount;
        totalBuyCost += newAmount * newRate;
        balanceCapital -= newAmount * newRate; // Deduct from capital
      } else if (transaction.type === 'Sell') {
        totalSold[transaction.currency] += newAmount;
        totalSellRevenue += newAmount * newRate;
        balanceCapital += newAmount * newRate; // Add to capital
      } else if (transaction.type === 'Take Profit') {
        totalTakenProfit += newAmount;
        balanceCapital -= newAmount; // Deduct from capital
      }

      // Save and update UI
      saveToLocalStorage();
      updateUI();
    }

    // Delete Transaction
    function deleteTransaction(index) {
      const transaction = transactions[index];
      if (confirm('Are you sure you want to delete this transaction?')) {
        // Revert the transaction's impact on totals
        if (transaction.type === 'Buy') {
          totalPurchased[transaction.currency] -= transaction.amount;
          totalBuyCost -= transaction.amount * transaction.rate;
          balanceCapital += transaction.amount * transaction.rate; // Add back to capital
        } else if (transaction.type === 'Sell') {
          totalSold[transaction.currency] -= transaction.amount;
          totalSellRevenue -= transaction.amount * transaction.rate;
          balanceCapital -= transaction.amount * transaction.rate; // Deduct from capital
        } else if (transaction.type === 'Take Profit') {
          totalTakenProfit -= transaction.amount;
          balanceCapital += transaction.amount; // Add back to capital
        }

        // Remove the transaction from the list
        transactions.splice(index, 1);

        // Save and update UI
        saveToLocalStorage();
        updateUI();
      }
    }

    // Buy Form Submission
    document.getElementById('buyForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const currency = document.getElementById('buyCurrency').value;
      const amount = parseFloat(document.getElementById('buyAmount').value);
      const rate = parseFloat(document.getElementById('buyRate').value);
      const remarks = document.getElementById('buyRemarks').value;
      const timestamp = new Date().toLocaleString();

      // Deduct amount from balanceCapital
      balanceCapital -= amount * rate;

      transactions.push({ type: 'Buy', currency, amount, rate, remarks, timestamp });
      totalPurchased[currency] += amount;
      totalBuyCost += amount * rate;

      saveToLocalStorage();
      updateUI();
    });

    // Sell Form Submission
    document.getElementById('sellForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const currency = document.getElementById('sellCurrency').value;
      const amount = parseFloat(document.getElementById('sellAmount').value);
      const rate = parseFloat(document.getElementById('sellRate').value);
      const remarks = document.getElementById('sellRemarks').value;
      const timestamp = new Date().toLocaleString();

      // Calculate the cost of the sold amount based on the average purchase cost
      const avgPurchaseCost = totalBuyCost / (totalPurchased.USD + totalPurchased.EUR + totalPurchased.USDT) || 0;
      const costOfSoldAmount = amount * avgPurchaseCost;

      // Calculate the profit from this sell transaction
      const profit = (amount * rate) - costOfSoldAmount;

      // Add amount to balanceCapital
      balanceCapital += amount * rate;

      // Add the sell transaction to history
      transactions.push({ type: 'Sell', currency, amount, rate, remarks, timestamp, profit });

      // Update totals
      totalSold[currency] += amount;
      totalSellRevenue += amount * rate;

      saveToLocalStorage();
      updateUI();
    });

    // Take Profit Form Submission
    document.getElementById('takeProfitForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('takeProfitAmount').value);

      // Deduct the take profit amount from the gross profit
      totalTakenProfit += amount;

      // Add the take profit transaction to history
      const timestamp = new Date().toLocaleString();
      transactions.push({ type: 'Take Profit', currency: 'MVR', amount, rate: 1, remarks: 'Profit Taken', timestamp });

      saveToLocalStorage();
      updateUI();
    });

    // Reset Button
    document.getElementById('resetButton').addEventListener('click', function (e) {
      e.preventDefault();
      resetApp();
    });
  </script>
</body>
</html>
